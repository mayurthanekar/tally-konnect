<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tally Konnect Import – On-Prem &amp; Cloud</title>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --surface2: #21262d;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --accent2: #388bfd;
      --success: #3fb950;
      --danger: #f85149;
      --radius: 8px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      padding: 1.5rem;
      line-height: 1.5;
    }
    .container {
      max-width: 520px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.35rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .sub {
      color: var(--muted);
      font-size: 0.875rem;
      margin-bottom: 1.25rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .card h2 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      margin: 0 0 1rem 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    label {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.35rem;
    }
    input[type="date"],
    input[type="text"],
    input[type="url"],
    input[type="password"] {
      width: 100%;
      padding: 0.55rem 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.95rem;
      margin-bottom: 0.9rem;
    }
    input::placeholder { color: var(--muted); }
    .tabs {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 1rem;
    }
    .tabs button {
      flex: 1;
      padding: 0.6rem 0.75rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
    }
    .tabs button:hover { background: var(--border); }
    .tabs button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .conn-panel { display: none; }
    .conn-panel.visible { display: block; }
    .btn-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .btn-row button { flex: 1; }
    button.primary {
      padding: 0.65rem 1rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
    }
    button.primary:hover { opacity: 0.9; }
    button.primary:disabled { opacity: 0.5; cursor: not-allowed; }
    button.secondary {
      padding: 0.65rem 1rem;
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.95rem;
      cursor: pointer;
    }
    button.secondary:hover { background: var(--border); }
    .result {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    .result.success { background: rgba(63, 185, 80, 0.15); color: var(--success); }
    .result.error { background: rgba(248, 81, 73, 0.15); color: var(--danger); }
    .result.info { background: rgba(88, 166, 255, 0.1); color: var(--accent); }
    .hint {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: -0.5rem;
      margin-bottom: 0.75rem;
    }
    .os-note {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tally Konnect Import</h1>
    <p class="sub">Import data into TallyERP live company from any OS (Linux, Windows). Connect via On-Prem or Cloud ERP.</p>

    <div class="card">
      <h2>Connection</h2>
      <div class="tabs">
        <button type="button" id="tabOnPrem" class="active">On-Prem TallyERP</button>
        <button type="button" id="tabCloud">Cloud ERP</button>
      </div>

      <div id="panelOnPrem" class="conn-panel visible">
        <label for="onPremUrl">Tally URL</label>
        <input type="text" id="onPremUrl" placeholder="http://localhost:9000" autocomplete="off">
        <p class="hint">Where Tally is listening (e.g. this PC: localhost:9000, or another machine: http://192.168.1.10:9000)</p>
        <div class="btn-row">
          <button type="button" id="btnTestOnPrem" class="secondary">Test connection</button>
        </div>
      </div>

      <div id="panelCloud" class="conn-panel">
        <label for="cloudUrl">Cloud ERP URL</label>
        <input type="text" id="cloudUrl" placeholder="https://your-tally-cloud-url" autocomplete="off">
        <label for="cloudApiKey">API key (optional)</label>
        <input type="password" id="cloudApiKey" placeholder="Bearer token if required" autocomplete="off">
        <p class="hint">Your Tally Cloud / hosted Tally endpoint. Add API key if your provider requires it.</p>
        <div class="btn-row">
          <button type="button" id="btnTestCloud" class="secondary">Test connection</button>
        </div>
      </div>

      <div id="connResult" class="result" style="display: none;"></div>
    </div>

    <div class="card">
      <h2>Import data</h2>
      <label for="fromDate">From date</label>
      <input type="date" id="fromDate" required>
      <label for="toDate">To date</label>
      <input type="date" id="toDate" required>
      <div class="btn-row">
        <button type="button" id="btnImport" class="primary">Fetch &amp; Import to Tally</button>
      </div>
      <button type="button" id="btnPreview" class="secondary" style="width: 100%; margin-top: 0.5rem;">Preview (fetch only)</button>
      <div id="result"></div>
    </div>

    <p class="os-note">Runs in the browser from any operating system. Ensure the import server is running and Tally (On-Prem or Cloud) is reachable from the server.</p>
  </div>

  <script>
    const STORAGE_KEY = 'tally-konnect-connection';

    const tabOnPrem = document.getElementById('tabOnPrem');
    const tabCloud = document.getElementById('tabCloud');
    const panelOnPrem = document.getElementById('panelOnPrem');
    const panelCloud = document.getElementById('panelCloud');
    const onPremUrl = document.getElementById('onPremUrl');
    const cloudUrl = document.getElementById('cloudUrl');
    const cloudApiKey = document.getElementById('cloudApiKey');
    const connResult = document.getElementById('connResult');
    const btnTestOnPrem = document.getElementById('btnTestOnPrem');
    const btnTestCloud = document.getElementById('btnTestCloud');
    const fromEl = document.getElementById('fromDate');
    const toEl = document.getElementById('toDate');
    const btnImport = document.getElementById('btnImport');
    const btnPreview = document.getElementById('btnPreview');
    const resultEl = document.getElementById('result');

    let connectionType = 'onprem';

    function loadDefaults() {
      fetch('/api/connection-defaults')
        .then(r => r.json())
        .then(data => {
          if (!onPremUrl.value) onPremUrl.value = data.onPremUrl || 'http://localhost:9000';
          if (!cloudUrl.value && data.cloudUrl) cloudUrl.value = data.cloudUrl;
        })
        .catch(() => {});
    }

    function loadSaved() {
      try {
        const s = localStorage.getItem(STORAGE_KEY);
        if (s) {
          const data = JSON.parse(s);
          if (data.onPremUrl) onPremUrl.value = data.onPremUrl;
          if (data.cloudUrl) cloudUrl.value = data.cloudUrl;
          if (data.cloudApiKey) cloudApiKey.value = data.cloudApiKey;
          if (data.connectionType === 'cloud') {
            connectionType = 'cloud';
            tabCloud.classList.add('active');
            tabOnPrem.classList.remove('active');
            panelOnPrem.classList.remove('visible');
            panelCloud.classList.add('visible');
          }
        }
      } catch (e) {}
    }

    function saveConnection() {
      const data = {
        connectionType,
        onPremUrl: onPremUrl.value.trim(),
        cloudUrl: cloudUrl.value.trim(),
        cloudApiKey: cloudApiKey.value || '',
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    tabOnPrem.addEventListener('click', () => {
      connectionType = 'onprem';
      tabOnPrem.classList.add('active');
      tabCloud.classList.remove('active');
      panelOnPrem.classList.add('visible');
      panelCloud.classList.remove('visible');
      connResult.style.display = 'none';
      saveConnection();
    });

    tabCloud.addEventListener('click', () => {
      connectionType = 'cloud';
      tabCloud.classList.add('active');
      tabOnPrem.classList.remove('active');
      panelCloud.classList.add('visible');
      panelOnPrem.classList.remove('visible');
      connResult.style.display = 'none';
      saveConnection();
    });

    function showConnResult(html, className) {
      connResult.innerHTML = html;
      connResult.className = 'result ' + (className || 'info');
      connResult.style.display = 'block';
    }

    async function testConnection(isCloud) {
      const url = isCloud ? cloudUrl.value.trim() : onPremUrl.value.trim();
      if (!url) {
        showConnResult('Please enter the Tally / Cloud ERP URL.', 'error');
        return;
      }
      saveConnection();
      showConnResult('Testing connection…', 'info');
      const body = {
        connectionType: isCloud ? 'cloud' : 'onprem',
        cloudUrl: isCloud ? url : undefined,
        tallyUrl: !isCloud ? url : undefined,
        cloudApiKey: isCloud ? cloudApiKey.value : undefined,
      };
      try {
        const r = await fetch('/api/test-connection', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await r.json();
        if (data.ok) {
          showConnResult('Connected.' + (data.companyName ? ' Company: ' + data.companyName : ''), 'success');
        } else {
          showConnResult(data.message || 'Connection failed', 'error');
        }
      } catch (e) {
        showConnResult('Error: ' + e.message, 'error');
      }
    }

    btnTestOnPrem.addEventListener('click', () => testConnection(false));
    btnTestCloud.addEventListener('click', () => testConnection(true));

    onPremUrl.addEventListener('blur', saveConnection);
    cloudUrl.addEventListener('blur', saveConnection);
    cloudApiKey.addEventListener('blur', saveConnection);

    function setDefaultDates() {
      const t = new Date();
      toEl.value = t.toISOString().slice(0, 10);
      const from = new Date(t);
      from.setMonth(from.getMonth() - 1);
      fromEl.value = from.toISOString().slice(0, 10);
    }

    function showResult(html, className) {
      resultEl.innerHTML = html;
      resultEl.className = 'result ' + (className || 'info');
    }

    function getImportBody() {
      const body = {
        fromDate: fromEl.value,
        toDate: toEl.value,
        connectionType,
      };
      if (connectionType === 'cloud') {
        body.cloudUrl = cloudUrl.value.trim();
        body.cloudApiKey = cloudApiKey.value || undefined;
      } else {
        body.tallyUrl = onPremUrl.value.trim();
      }
      return body;
    }

    async function doImport() {
      const fromDate = fromEl.value;
      const toDate = toEl.value;
      if (!fromDate || !toDate) {
        showResult('Please select From and To dates.', 'error');
        return;
      }
      const url = connectionType === 'cloud' ? cloudUrl.value.trim() : onPremUrl.value.trim();
      if (!url) {
        showResult('Please enter Tally URL (On-Prem) or Cloud ERP URL in Connection.', 'error');
        return;
      }
      saveConnection();
      btnImport.disabled = true;
      showResult('Fetching from Konnect and importing to Tally…', 'info');
      try {
        const r = await fetch('/api/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(getImportBody()),
        });
        const data = await r.json();
        if (data.success) {
          showResult(
            'Imported: ' + (data.tallyCreated || 0) + ' created, ' + (data.tallyAltered || 0) + ' altered. ' +
            '(Fetched ' + (data.konnectFetched || 0) + ' from Konnect.)',
            'success'
          );
        } else {
          showResult(data.error || data.message || 'Import failed.', 'error');
        }
      } catch (e) {
        showResult('Error: ' + e.message, 'error');
      } finally {
        btnImport.disabled = false;
      }
    }

    async function doPreview() {
      const fromDate = fromEl.value;
      const toDate = toEl.value;
      if (!fromDate || !toDate) {
        showResult('Please select From and To dates.', 'error');
        return;
      }
      btnPreview.disabled = true;
      showResult('Fetching from Konnect…', 'info');
      try {
        const r = await fetch('/api/preview?fromDate=' + encodeURIComponent(fromDate) + '&toDate=' + encodeURIComponent(toDate));
        const data = await r.json();
        if (data.error) {
          showResult(data.error, 'error');
        } else {
          showResult('Fetched ' + (data.count || 0) + ' transaction(s). Ready to import.', 'success');
        }
      } catch (e) {
        showResult('Error: ' + e.message, 'error');
      } finally {
        btnPreview.disabled = false;
      }
    }

    btnImport.addEventListener('click', doImport);
    btnPreview.addEventListener('click', doPreview);

    setDefaultDates();
    loadDefaults();
    loadSaved();
  </script>
</body>
</html>
